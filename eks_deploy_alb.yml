apiVersion: apps/v1
kind: Deployment
metadata:
  name: crudpro
  labels:
    app: crudpro
spec:
  replicas: 2
  selector:
    matchLabels:
      app: crudpro
  template:
    metadata:
      labels:
        app: crudpro
    spec:
      containers:
        - name: crudapp
          image: ${ECR_REPO_URI}:latest
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
          ports:
            - containerPort: 8090
          imagePullPolicy: Always
          resources:
            limits:
              memory: "512Mi"
              cpu: "500m"
            requests:
              memory: "256Mi"
              cpu: "250m"

---
apiVersion: v1
kind: Service
metadata:
  name: spring-boot-service
  labels:
    app: crudpro
spec:
  selector:
    app: crudpro
  ports:
    - protocol: TCP
      port: 80            # ALB가 접근할 포트
      targetPort: 8090    # 컨테이너 내부 포트
  type: ClusterIP       # ALB controller (Ingress) 사용 시 ClusterIP 권장 (pod IP 직접 target 등록)

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: crudpro-ingress
  namespace: default
  annotations:
    # ALB 컨트롤러 동작 관련 필수/권장 어노테이션
    kubernetes.io/ingress.class: "alb"                                 # ingressClassName 대신 안전하게 지정
    alb.ingress.kubernetes.io/scheme: internet-facing                    # internet-facing 또는 internal
    alb.ingress.kubernetes.io/target-type: ip                            # ip -> pod IP를 타깃으로 등록 (노드 대신)
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80}]'              # HTTP 포트 설정
    alb.ingress.kubernetes.io/healthcheck-path: "/actuator/health"                      # ALB 헬스체크 경로 (서비스에 맞게 조정) 앱에서 인증 없이 200을 반환하는 헬스 엔드포인트(예: /actuator/health)를 추가 시큐리티랑 필터에추가
    alb.ingress.kubernetes.io/healthcheck-port: "traffic-port"  #port: 80 targetPort: 8090 이므로 ALB가 Service→Pod로 보낼 때 내부적으로 올바른 포트(=8090)로 전달되도록 컨트롤러가 처리
    # 필요 시 세부 설정 추가 (예: 인증, WAF, stickiness 등)
spec:
  rules:
#    - host: example.yourdomain.com    # 실제 도메인으로 교체.
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: spring-boot-service
                port:
                  number: 80
#  defaultBackend:  #ALB DNS 이름(예: a12345-abcdef.ap-northeast-2.elb.amazonaws.com)으로 바로 접속
#    service:
#      name: spring-boot-service
#      port:
#        number: 80